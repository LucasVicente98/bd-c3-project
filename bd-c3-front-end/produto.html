<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos Frontend</title>
    <link rel="stylesheet" href="./style/styles.css">
</head>

<body>

    <header>
        <a href="menu_armazem.html" style="display: flex; align-items: center; text-decoration: none;">
            <button>Voltar ao menu principal</button>
        </a>
        <h1>Armazéns</h1>
    </header>

    <section id="listarProdutos">
        <button onclick="getProdutos()">Listar Produtos</button>
        <div id="produtosList"></div>
    </section>

    <section id="criarProduto">
        <h2>Criar Novo Produto</h2>
        <form onsubmit="postProduto(event)">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" required>
            <br>
            <label for="quantidade">Quantidade:</label>
            <input type="number" id="quantidade" required>
            <br>
            <label for="valor">Valor:</label>
            <input type="number" id="valor" required>
            <br>
            <label for="dataValidade">Data de Validade:</label>
            <input type="date" id="dataValidade" required>
            <br>
            <label for="armazemNome">Nome do Armazém:</label>
            <input type="text" id="armazemNome" required>
            <br>
            <button type="submit">Criar Produto</button>
        </form>
    </section>

    <section id="estatisticas">
        <h2>Estatísticas</h2>

        <div id="mediaPrecoList">
            <h3>Média de Preço por Armazém</h3>
        </div>

        <div id="valorTotalPorArmazemList">
            <h3>Valor Total de Produtos por Armazém</h3>
        </div>

        <div id="valorTotalProdutos">
            <h3>Valor Total de Produtos</h3>
        </div>
    </section>

  <script>
        const apiUrl = 'http://localhost:4000/produto';

        function getProdutos() {
            fetch(apiUrl)
                .then(response => response.json())
                .then(produtos => {
                    const produtosList = document.getElementById('produtosList');
                    produtosList.innerHTML = '<h3>Lista de Produtos</h3>';

                    produtos.forEach(produto => {
                        const produtoDiv = document.createElement('div');
                        produtoDiv.innerHTML = `
                            <p><strong>Nome:</strong> ${produto.nome}</p>
                            <p><strong>Quantidade:</strong> ${produto.quantidade}</p>
                            <p><strong>Valor:</strong> ${produto.valor}</p>
                            <p><strong>Data de Validade:</strong> ${produto.data_validade}</p>
                            <p><strong>Armazém:</strong> ${produto.armazem_id ? produto.armazem_id.nome : 'Sem Armazém'}</p>
                            <button onclick="editProduto('${produto._id}')">Editar</button>
                            <button onclick="deleteProduto('${produto._id}')">Excluir</button>
                            <hr>
                        `;
                        produtosList.appendChild(produtoDiv);
                    });
                })
                .catch(error => console.error('Erro ao obter produtos:', error));
        }

        function postProduto(event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value;
            const quantidade = document.getElementById('quantidade').value;
            const valor = document.getElementById('valor').value;
            const dataValidade = document.getElementById('dataValidade').value;
            const armazemNome = document.getElementById('armazemNome').value;

            const newProduto = {
                nome,
                quantidade,
                valor,
                data_validade: dataValidade,
                armazem_id: { nome: armazemNome },
            };

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newProduto),
            })
                .then(response => response.json())
                .then(data => {
                    alert('Novo Produto criado com sucesso!');
                    getProdutos();
                })
                .catch(error => console.error('Erro ao criar produto:', error));
        }

        function editProduto(produtoId) {
            const newNome = prompt('Digite o novo nome para o produto:');
            const newQuantidade = prompt('Digite a nova quantidade para o produto:');
            const newValor = prompt('Digite o valor atualizado do produto:');
            const newDataValidade = prompt('Digite a nova data de validade para o produto:');

            if (newNome !== null && newQuantidade !== null && newValor !== null && newDataValidade !== null) {
                const updatedProduto = {
                    nome: newNome,
                    quantidade: newQuantidade,
                    valor: newValor,
                    data_validade: newDataValidade,
                };

                fetch(`${apiUrl}/${produtoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedProduto),
                })
                    .then(response => response.json())
                    .then(data => {
                        alert('Produto atualizado com sucesso!');
                        getProdutos();
                    })
                    .catch(error => console.error('Erro ao atualizar produto:', error));
            }
        }

        function deleteProduto(produtoId) {
            const confirmDelete = confirm('Tem certeza de que deseja excluir este produto?');

            if (confirmDelete) {
                fetch(`${apiUrl}/${produtoId}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        alert('Produto excluído com sucesso!');
                        getProdutos();
                    })
                    .catch(error => console.error('Erro ao excluir produto:', error));
            }
        }

        function getMediaPrecoPorArmazem() {
            fetch(`${apiUrl}/media-preco-por-armazem`)
                .then(response => response.json())
                .then(mediaPrecoList => {
                    const mediaPrecoListDiv = document.getElementById('mediaPrecoList');
                    mediaPrecoListDiv.innerHTML = '<h3>Média de Preço por Armazém</h3>';

                    mediaPrecoList.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.innerHTML = `
                            <p><strong>Armazém:</strong> ${item.armazem.nome}</p>
                            <p><strong>Média de Preço:</strong> ${formatarReal(item.mediaPreco)}</p>
                            <hr>
                        `;
                        mediaPrecoListDiv.appendChild(itemDiv);
                    });
                })
                .catch(error => console.error('Erro ao obter média de preço por armazém:', error));
        }

        function getValorTotalPorArmazem() {
            fetch(`${apiUrl}/vlr-total-produtos-por-armazem`)
                .then(response => response.json())
                .then(valorTotalPorArmazemList => {
                    const valorTotalPorArmazemListDiv = document.getElementById('valorTotalPorArmazemList');
                    valorTotalPorArmazemListDiv.innerHTML = '<h3>Valor Total de Produtos por Armazém</h3>';

                    valorTotalPorArmazemList.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.innerHTML = `
                            <p><strong>Armazém:</strong> ${item._id.nome}</p>
                            <p><strong>Valor Total:</strong> ${formatarReal(item.valorTotal)}</p>
                            <hr>
                        `;
                        valorTotalPorArmazemListDiv.appendChild(itemDiv);
                    });
                })
                .catch(error => console.error('Erro ao obter valor total por armazém:', error));
        }

        function getValorTotalProdutos() {
            fetch(`${apiUrl}/vlr-total-produtos`)
                .then(response => response.json())
                .then(valorTotal => {
                    const valorTotalProdutosDiv = document.getElementById('valorTotalProdutos');
                    valorTotalProdutosDiv.innerHTML = `<h3>Valor Total de Produtos: ${formatarReal(valorTotal.valorTotal)}</h3>`;
                })
                .catch(error => console.error('Erro ao obter valor total de produtos:', error));
        }

        function formatarReal(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        // Chamar as funções ao carregar a página
        getMediaPrecoPorArmazem();
        getValorTotalPorArmazem();
        getValorTotalProdutos();
    </script>

</body>

</html>
